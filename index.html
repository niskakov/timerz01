<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="School Tracker">
  <title>School Time Tracker</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      background: linear-gradient(180deg, #f0f2f5 0%, #e5e7eb 100%);
      color: #000;
      overflow: auto;
    }
    .widget-container {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 15px;
      width: 90%;
      max-width: 300px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      animation: slideIn 0.5s ease-out;
    }
    #status {
      font-size: 1em;
      font-weight: 600;
      text-align: center;
      margin-bottom: 10px;
      color: #007AFF;
    }
    @keyframes blink {
      0% { opacity: 1; }
      50% { opacity: 0; }
      100% { opacity: 1; }
    }
    .blinking {
      animation: blink 1s 3;
    }
    #daily-time {
      font-size: 0.9em;
      text-align: center;
      margin-bottom: 10px;
    }
    .button-group {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }
    button {
      background: #007AFF;
      color: white;
      border: none;
      padding: 8px 15px;
      font-size: 0.9em;
      font-weight: 500;
      border-radius: 10px;
      cursor: pointer;
      flex: 1;
      transition: transform 0.1s, background 0.2s;
    }
    button:active {
      transform: scale(0.95);
      background: #005BB5;
    }
    button:disabled {
      background: #C7C7CC;
      cursor: not-allowed;
    }
    .full-reports {
      margin-top: 15px;
      font-size: 0.9em;
    }
    .full-reports p {
      margin: 5px 0;
      display: flex;
      justify-content: space-between;
      padding: 8px;
      background: rgba(0, 0, 0, 0.05);
      border-radius: 8px;
    }
    .notification {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: #007AFF;
      color: white;
      padding: 10px;
      border-radius: 5px;
      z-index: 1000;
    }
    #username-section {
      margin-bottom: 10px;
      text-align: center;
    }
    #username-input {
      padding: 5px;
      font-size: 1em;
      border-radius: 5px;
      width: 80%;
      margin-bottom: 5px;
    }
    #username-display {
      font-size: 1em;
      font-weight: 500;
    }
    #export-import {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
    #export-import button {
      background: #34C759;
    }
    #export-import button:active {
      background: #28A745;
    }
    #import-input {
      display: none;
    }
    #achievements {
      margin-top: 10px;
    }
    #achievements ul {
      list-style: none;
      padding: 0;
    }
    #achievements li {
      margin: 5px 0;
    }
    body.dark-theme {
      background: linear-gradient(180deg, #1c2526 0%, #2d3b3c 100%);
      color: #fff;
    }
    body.dark-theme .widget-container {
      background: rgba(30, 30, 30, 0.9);
    }
    body.dark-theme .full-reports p {
      background: rgba(255, 255, 255, 0.1);
    }
    @keyframes slideIn {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="widget-container">
    <div id="username-section">
      <div id="username-display"></div>
      <input type="text" id="username-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è">
      <button onclick="saveUsername()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–º—è</button>
    </div>
    <div id="status">–û–∂–∏–¥–∞–Ω–∏–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏...</div>
    <div id="daily-time">–°–µ–≥–æ–¥–Ω—è: 0 —á 0 –º–∏–Ω 0 —Å–µ–∫</div>
    <div class="button-group">
      <button id="startButton">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
      <button id="stopButton" disabled>–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
    </div>
    <div id="export-import">
      <button onclick="exportData()">–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
      <button onclick="document.getElementById('import-input').click()">–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
      <input type="file" id="import-input" accept=".json" onchange="importData(event)">
    </div>
    <div class="full-reports">
      <p>–ù–µ–¥–µ–ª—è: <span id="weekly">0 —á 0 –º–∏–Ω 0 —Å–µ–∫</span></p>
      <p>–ú–µ—Å—è—Ü: <span id="monthly">0 —á 0 –º–∏–Ω 0 —Å–µ–∫</span></p>
      <p>–í—Å–µ–≥–æ: <span id="total">0 —á 0 –º–∏–Ω 0 —Å–µ–∫</span></p>
      <p>–°—Ä–µ–¥–Ω–µ–µ –∑–∞ –¥–µ–Ω—å (7 –¥–Ω–µ–π): <span id="average">0 —á 0 –º–∏–Ω 0 —Å–µ–∫</span></p>
    </div>
    <div id="achievements">
      <h4>–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h4>
      <ul id="achievements-list"></ul>
    </div>
    <div style="margin-top: 10px;">
      <label>–¢—ë–º–Ω–∞—è —Ç–µ–º–∞: <input type="checkbox" id="dark-theme" onchange="toggleTheme()"></label>
    </div>
  </div>

  <script>
    // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —à–∫–æ–ª—ã (–∂—ë—Å—Ç–∫–æ –ø—Ä–æ–ø–∏—Å–∞–Ω—ã)
    const SCHOOL_LAT = 51.088513;
    const SCHOOL_LON = 71.414179;
    const SCHOOL_RADIUS = 100;

    // –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö
    let trackingData = JSON.parse(localStorage.getItem('trackingData')) || {
      sessions: [],
      lastCheckTime: Date.now(),
      isInSchool: false,
      isTimerRunning: false
    };
    let username = localStorage.getItem('username') || '';
    let achievements = JSON.parse(localStorage.getItem('achievements')) || [];
    let lastWeeklyCheck = localStorage.getItem('lastWeeklyCheck') || 0;
    let lastWorkWish = parseInt(localStorage.getItem('lastWorkWish')) || 0;
    let lastLocationCheck = 0;
    let isNotificationActive = false;
    const usernameDisplay = document.getElementById('username-display');
    const usernameInput = document.getElementById('username-input');
    const usernameSection = document.getElementById('username-section');
    const startButton = document.getElementById('startButton');
    const stopButton = document.getElementById('stopButton');
    let timerInterval = null;

    const quotes = [
      "–£—á—ë–±–∞ ‚Äî —ç—Ç–æ —Ç–≤–æ–π –¥–≤–∏–∂, –≤—Ä—É–±–∞–π –ø–æ–ª–Ω—ã–π –≥–∞–∑! üöÄ",
      "–¢—ã –±–ª–∏–∂–µ –∫ —Ç–æ–ø—É, –±—Ä–∞—Ç–∏—à–∫–∞, –Ω–µ —Ç—Ä—ã–Ω–¥–µ—Ü! üåü",
      "–ó–Ω–∞–Ω–∏—è ‚Äî —ç—Ç–æ —Ç–≤–æ–π –ª—É—Ç, –∫–∞—á–∞–π –¥–∞–ª—å—à–µ! üí™",
      "–°–µ–≥–æ–¥–Ω—è –¥–µ–Ω—å, —á—Ç–æ–±—ã –∑–∞—Ä–µ—à–∞—Ç—å –≤—Å—ë –Ω–∞ —á–∏–ª–µ! üìö"
    ];

    function getRandomQuote() {
      return quotes[Math.floor(Math.random() * quotes.length)];
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function initUsername() {
      if (username) {
        usernameDisplay.textContent = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${username}`;
        usernameInput.style.display = 'none';
        usernameSection.querySelector('button').style.display = 'none';
      } else {
        usernameDisplay.textContent = '';
        usernameInput.style.display = 'block';
        usernameSection.querySelector('button').style.display = 'block';
      }
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function saveUsername() {
      username = usernameInput.value.trim();
      if (username) {
        localStorage.setItem('username', username);
        initUsername();
        showNotification('–ò–º—è –∑–∞—à–ª–æ —á—ë—Ç–∫–æ! üëç');
      } else {
        showNotification('–≠–π, –±–µ–∑ –∏–º–µ–Ω–∏ –Ω–µ —Ç—Ä—ã–Ω–¥–µ—Ü, –≤–≤–µ–¥–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å! üòú');
      }
    }

    // –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
    function exportData() {
      const data = {
        username: username,
        trackingData: trackingData,
        achievements: achievements
      };
      const dataStr = JSON.stringify(data, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `school-tracker-${username || 'user'}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showNotification('–î–∞–Ω–Ω—ã–µ –Ω–∞ —ç–∫—Å–ø–æ—Ä—Ç —É–ª–µ—Ç–µ–ª–∏! üöÄ –ß–µ–∫–∞–π —Ñ–∞–π–ª!');
      localStorage.setItem('lastExport', Date.now());
    }

    // –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          if (data.username && data.trackingData) {
            username = data.username;
            trackingData = data.trackingData;
            achievements = data.achievements || [];
            localStorage.setItem('username', username);
            localStorage.setItem('trackingData', JSON.stringify(trackingData));
            localStorage.setItem('achievements', JSON.stringify(achievements));
            initUsername();
            updateStatus();
            updateReports();
            updateAchievementsDisplay();
            showNotification('–î–∞–Ω–Ω—ã–µ –∑–∞—Ç–∞—â–∏–ª–∏, –≤—Å—ë –Ω–æ—Ä–º! ü§ë');
          } else {
            showNotification('–§–∞–π–ª –Ω–µ —Ç—è–Ω–µ—Ç, –≤—ã–±–µ—Ä–∏ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π! üòÖ');
          }
        } catch (err) {
          showNotification('–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –ø–æ—Ö–µ—Ä, —Ñ–∞–π–ª –∫—Ä–∏–≤–æ–π! ü§î');
        }
      };
      reader.readAsText(file);
    }

    function checkExportReminder() {
      const lastExport = parseInt(localStorage.getItem('lastExport')) || 0;
      const now = Date.now();
      const week = 7 * 24 * 60 * 60 * 1000;
      if (now - lastExport > week) {
        showNotification('–ë—Ä–æ, –Ω–µ –∑–∞–±—É–¥—å –¥–∞–Ω–Ω—ã–µ —Å–∫–∏–Ω—É—Ç—å –≤ —Ñ–∞–π–ª, –∞ —Ç–æ –ø–æ—Ç–µ—Ä—è–µ—à—å –≤—Å—ë –Ω–∞—Ñ–∏–≥! üì•');
      }
    }

    function toggleTheme() {
      const isDark = document.getElementById('dark-theme').checked;
      document.body.classList.toggle('dark-theme', isDark);
      localStorage.setItem('darkTheme', isDark);
    }

    // –†–∞—Å—á–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const œÜ1 = lat1 * Math.PI / 180;
      const œÜ2 = lat2 * Math.PI / 180;
      const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
      const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function parseTimeToSeconds(timeStr) {
      const [hours, minutes, seconds] = timeStr.match(/\d+/g).map(Number);
      return hours * 3600 + minutes * 60 + seconds;
    }

    function checkAchievements(currentTime) {
      const date = new Date(currentTime);
      const hours = date.getHours();

      if (hours < 8 && !achievements.includes('early_bird')) {
        achievements.push('early_bird');
        showNotification('üèÜ –ê—á–∏–≤–∫–∞ –≤ –∫–∞—Ä–º–∞–Ω–µ: –†–∞–Ω–Ω–∏–π –ø—Ç–∞—à–∫–∞! –¢—ã –≤ —à–∫–æ–ª–µ –¥–æ 8 —É—Ç—Ä–∞, –∫—Ä–∞—Å–∞–≤–∞! ‚òÄÔ∏è');
      }
      if (hours >= 18 && !achievements.includes('night_owl')) {
        achievements.push('night_owl');
        showNotification('üèÜ –ê—á–∏–≤–∫–∞: –°–æ–≤–∞! –¢—ã —Ç—É—Å—É–µ—à—å –≤ —à–∫–æ–ª–µ –ø–æ—Å–ª–µ 18:00, –≤–∞—â–µ –æ–≥–æ–Ω—å! üåô');
      }

      const todayStart = new Date(currentTime).setHours(0, 0, 0, 0);
      const todayTime = calculateTimeInPeriod(todayStart, currentTime);
      const totalSeconds = parseTimeToSeconds(todayTime);
      if (totalSeconds > 10 * 3600 && !achievements.includes('marathon')) {
        achievements.push('marathon');
        showNotification('üèÜ –ê—á–∏–≤–∫–∞: –ú–∞—Ä–∞—Ñ–æ–Ω–µ—Ü! 10+ —á–∞—Å–æ–≤ –≤ —à–∫–æ–ª–µ, —Ç—ã –ø—Ä–æ—Å—Ç–æ –º–æ–Ω—Å—Ç—Ä! üí•');
      }

      localStorage.setItem('achievements', JSON.stringify(achievements));
      updateAchievementsDisplay();
    }

    function updateAchievementsDisplay() {
      const list = document.getElementById('achievements-list');
      list.innerHTML = '';
      achievements.forEach(achievement => {
        const li = document.createElement('li');
        if (achievement === 'early_bird') li.textContent = 'üèÜ –†–∞–Ω–Ω–∏–π –ø—Ç–∞—à–∫–∞: –ü—Ä–∏—à—ë–ª –¥–æ 8 —É—Ç—Ä–∞';
        if (achievement === 'night_owl') li.textContent = 'üèÜ –°–æ–≤–∞: –û—Å—Ç–∞–≤–∞–ª—Å—è –ø–æ—Å–ª–µ 18:00';
        if (achievement === 'marathon') li.textContent = 'üèÜ –ú–∞—Ä–∞—Ñ–æ–Ω–µ—Ü: –ü—Ä–æ–≤—ë–ª –±–æ–ª–µ–µ 10 —á–∞—Å–æ–≤ –≤ —à–∫–æ–ª–µ';
        list.appendChild(li);
      });
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è
    function checkLocation(position) {
      const currentTime = Date.now();
      if (currentTime - lastLocationCheck < 5000) {
        console.log('checkLocation: —Å–ª–∏—à–∫–æ–º —Ä–∞–Ω–æ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º');
        return;
      }
      lastLocationCheck = currentTime;
      console.log('checkLocation: –≤—ã–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è');

      const { latitude, longitude } = position.coords;
      const distance = calculateDistance(latitude, longitude, SCHOOL_LAT, SCHOOL_LON);

      console.log(`–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${latitude}, ${longitude}, –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${distance} –º`);

      if (distance <= SCHOOL_RADIUS) {
        if (!trackingData.isInSchool) {
          trackingData.isInSchool = true;
          if (!trackingData.isTimerRunning) {
            startTimerLogic(currentTime);
            showNotification('–¢—ã –≤ —à–∫–æ–ª–µ, –±—Ä–∞—Ç–∏—à–∫–∞! –¢–∞–π–º–µ—Ä –ø–æ–µ—Ö–∞–ª, –ø–æ–≥–Ω–∞–ª–∏ —É—á–∏—Ç—å—Å—è! üìö');
          }
          checkAchievements(currentTime);
          updateStatus();
        } else {
          checkAchievements(currentTime);
          const todayStart = new Date(currentTime).setHours(0, 0, 0, 0);
          const todayTime = calculateTimeInPeriod(todayStart, currentTime);
          const totalSeconds = parseTimeToSeconds(todayTime);
          if (totalSeconds > 8 * 3600) {
            showNotification('–¢—ã –≤ —à–∫–æ–ª–µ —É–∂–µ 8+ —á–∞—Å–æ–≤, –±—Ä–∞—Ç–∏—à–∫–∞! –ü–æ—Ö–µ—Ä, –Ω–µ –∑–∞–±—É–¥—å —á–∏–ª–ª–∞–Ω—É—Ç—å! üõãÔ∏è');
          }
          const hour = 60 * 60 * 1000;
          if (currentTime - lastWorkWish >= hour) {
            showNotification('–î–µ—Ä–∂–∏ —Ä–∏—Ç–º, –±—Ä–∞—Ç–∏—à–∫–∞! –ü—É—Å—Ç—å –≤—Å—ë –∑–∞—Ö–æ–¥–∏—Ç –Ω–∞ —É—Ä–∞ –∏ —Ä–∞–±–æ—Ç–∞ –ø—Ä—ë—Ç! üöÄ');
            lastWorkWish = currentTime;
            localStorage.setItem('lastWorkWish', lastWorkWish);
          }
        }
      } else {
        if (trackingData.isInSchool) {
          trackingData.isInSchool = false;
          if (trackingData.isTimerRunning) {
            stopTimerLogic(currentTime);
            showNotification('–ü–æ–∫–∏–Ω—É–ª —à–∫–æ–ª—É, —Ç–∞–π–º–µ—Ä –Ω–∞ –ø–∞—É–∑–µ. –û—Ç–¥—ã—Ö–∞–π, –ª–µ–≥–µ–Ω–¥–∞! üòé');
          }
          updateStatus();
        }
      }

      trackingData.lastCheckTime = currentTime;
      localStorage.setItem('trackingData', JSON.stringify(trackingData));
    }

    // –õ–æ–≥–∏–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ç–∞–π–º–µ—Ä–∞
    function startTimer() {
      console.log('startTimer –≤—ã–∑–≤–∞–Ω–∞');
      const currentTime = Date.now();
      console.log('–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è:', currentTime);
      startTimerLogic(currentTime);
      trackingData.lastCheckTime = currentTime;
      localStorage.setItem('trackingData', JSON.stringify(trackingData));
      updateStatus();
    }

    function startTimerLogic(currentTime) {
      console.log('startTimerLogic: isTimerRunning =', trackingData.isTimerRunning);
      if (!trackingData.isTimerRunning) {
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é —Å–µ—Å—Å–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ –æ—Å—Ç–∞–ª–∞—Å—å –æ—Ç–∫—Ä—ã—Ç–æ–π
        const lastSession = trackingData.sessions[trackingData.sessions.length - 1];
        if (lastSession && !lastSession.end) {
          lastSession.end = currentTime;
          console.log('–ó–∞–∫—Ä—ã–≤–∞–µ–º –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—É—é —Å–µ—Å—Å–∏—é:', lastSession);
        }

        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }

        trackingData.isTimerRunning = true;
        trackingData.sessions.push({ start: currentTime, end: null });
        startButton.disabled = true;
        stopButton.disabled = false;
        console.log('–ö–Ω–æ–ø–∫–∏: startButton.disabled =', startButton.disabled, 'stopButton.disabled =', stopButton.disabled);

        timerInterval = setInterval(() => {
          updateReports();
        }, 1000); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
        showNotification(getRandomQuote());
        showNotification('–ì–æ–Ω–∏ –Ω–∞ –ø–æ–ª–Ω—É—é, –±—Ä–∞—Ç–∏—à–∫–∞! –ü—É—Å—Ç—å —Ä–∞–±–æ—Ç–∞ –±—É–¥–µ—Ç –≤ –∫–∞–π—Ñ –∏ –≤—Å—ë –∑–∞—Ä–µ—à–∏—Ç—Å—è! üí•');
      } else {
        console.log('–¢–∞–π–º–µ—Ä —É–∂–µ –∑–∞–ø—É—â–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º');
      }
    }

    // –õ–æ–≥–∏–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç–∞–π–º–µ—Ä–∞
    function stopTimer() {
      console.log('stopTimer –≤—ã–∑–≤–∞–Ω–∞');
      const currentTime = Date.now();
      console.log('–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è:', currentTime);
      stopTimerLogic(currentTime);
      trackingData.lastCheckTime = currentTime;
      localStorage.setItem('trackingData', JSON.stringify(trackingData));
      updateStatus();
    }

    function stopTimerLogic(currentTime) {
      console.log('stopTimerLogic: isTimerRunning =', trackingData.isTimerRunning);
      if (trackingData.isTimerRunning) {
        trackingData.isTimerRunning = false;
        const lastSession = trackingData.sessions[trackingData.sessions.length - 1];
        if (lastSession && !lastSession.end) {
          lastSession.end = currentTime;
          console.log('–°–µ—Å—Å–∏—è –∑–∞–∫—Ä—ã—Ç–∞:', lastSession);
        } else {
          console.log('–û—à–∏–±–∫–∞: –ø–æ—Å–ª–µ–¥–Ω—è—è —Å–µ—Å—Å–∏—è —É–∂–µ –∑–∞–∫—Ä—ã—Ç–∞ –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç');
        }
        startButton.disabled = false;
        stopButton.disabled = true;
        console.log('–ö–Ω–æ–ø–∫–∏: startButton.disabled =', startButton.disabled, 'stopButton.disabled =', stopButton.disabled);

        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
          console.log('–¢–∞–π–º–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
        } else {
          console.log('–û—à–∏–±–∫–∞: timerInterval –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω');
        }
      } else {
        console.log('–¢–∞–π–º–µ—Ä —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
      }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
    function updateStatus() {
      let statusText = trackingData.isTimerRunning ? '–¢–∞–π–º–µ—Ä –∑–∞–ø—É—â–µ–Ω' : '–¢–∞–π–º–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
      if (trackingData.isInSchool) {
        statusText += ' (–í —à–∫–æ–ª–µ)';
      } else {
        statusText += ' (–í–Ω–µ —à–∫–æ–ª—ã)';
      }
      const statusElement = document.getElementById('status');
      statusElement.textContent = statusText;
      if (trackingData.isTimerRunning) {
        statusElement.classList.add('blinking');
      }
    }

    // –í–∏–∑—É–∞–ª—å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    function showNotification(message) {
      if (isNotificationActive) return;

      isNotificationActive = true;
      const notification = document.createElement('div');
      notification.textContent = message;
      notification.className = 'notification';
      document.body.appendChild(notification);
      setTimeout(() => {
        notification.remove();
        isNotificationActive = false;
      }, 3000);
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
    function handleError(error) {
      let errorMessage;
      switch(error.code) {
        case error.PERMISSION_DENIED:
          errorMessage = '–ë—Ä–æ, —Ç—ã –Ω–µ –¥–∞–ª –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏. –ë–µ–∑ —ç—Ç–æ–≥–æ –Ω–µ —Ç—Ä—ã–Ω–¥–µ—Ü, –≤–∫–ª—é—á–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö! üìç';
          break;
        case error.POSITION_UNAVAILABLE:
          errorMessage = '–ù–µ –º–æ–≥—É –Ω–∞–π—Ç–∏ —Ç–≤–æ—é –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é, —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –ø–æ—Ö–µ—Ä! ü§î';
          break;
        case error.TIMEOUT:
          errorMessage = '–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è —Ç–∞–π–º–∞—É—Ç–Ω—É–ª–∞—Å—å, –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑, –±—Ä–∞—Ç–∏—à–∫–∞! ‚è≥';
          break;
        default:
          errorMessage = `–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏: ${error.message}`;
      }
      document.getElementById('status').textContent = errorMessage;
      console.log(error);
      showNotification(errorMessage);
    }

    // –†–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –∑–∞ –ø–µ—Ä–∏–æ–¥
    function calculateTimeInPeriod(start, end) {
      let totalSeconds = 0;
      trackingData.sessions.forEach(session => {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü —Å–µ—Å—Å–∏–∏
        const sessionStart = session.start;
        const sessionEnd = session.end || Date.now();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç—Å—è –ª–∏ —Å–µ—Å—Å–∏—è —Å –ø–µ—Ä–∏–æ–¥–æ–º
        if (sessionStart <= end && sessionEnd >= start) {
          // –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ: –Ω–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞ —Å–µ—Å—Å–∏–∏ –≤–Ω—É—Ç—Ä–∏ [start, end]
          const effectiveStart = Math.max(sessionStart, start);
          const effectiveEnd = Math.min(sessionEnd, end);
          totalSeconds += (effectiveEnd - effectiveStart) / 1000;
        }
      });
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = Math.floor(totalSeconds % 60);
      return `${hours} —á ${minutes} –º–∏–Ω ${seconds} —Å–µ–∫`;
    }

    // –†–∞—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞ –¥–µ–Ω—å
    function calculateAverageDailyTime() {
      const now = new Date();
      const weekStart = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7).getTime();
      const dailySessions = {};

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º 7 –¥–Ω–µ–π
      for (let i = 0; i < 7; i++) {
        const dayStart = weekStart + i * 24 * 60 * 60 * 1000;
        dailySessions[dayStart] = 0;
      }

      trackingData.sessions.forEach(session => {
        const sessionStart = session.start;
        const sessionEnd = session.end || Date.now();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–ø–∞–¥–∞–µ—Ç –ª–∏ —Å–µ—Å—Å–∏—è –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
        if (sessionStart <= now.getTime() && sessionEnd >= weekStart) {
          // –î–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è –≤ –ø–µ—Ä–∏–æ–¥–µ —Å–µ—Å—Å–∏–∏
          const startDay = new Date(sessionStart).setHours(0, 0, 0, 0);
          const endDay = new Date(sessionEnd).setHours(0, 0, 0, 0);

          for (let day = startDay; day <= endDay; day += 24 * 60 * 60 * 1000) {
            if (day >= weekStart) {
              const dayEnd = day + 24 * 60 * 60 * 1000;
              const effectiveStart = Math.max(sessionStart, day);
              const effectiveEnd = Math.min(sessionEnd, dayEnd);
              const seconds = (effectiveEnd - effectiveStart) / 1000;
              dailySessions[day] = (dailySessions[day] || 0) + seconds;
            }
          }
        }
      });

      // –°—á–∏—Ç–∞–µ–º —Å—Ä–µ–¥–Ω–µ–µ
      let totalSeconds = 0;
      let daysWithSessions = 0;
      for (const day in dailySessions) {
        if (dailySessions[day] > 0) {
          totalSeconds += dailySessions[day];
          daysWithSessions++;
        }
      }

      const averageSeconds = daysWithSessions ? totalSeconds / daysWithSessions : 0;
      const hours = Math.floor(averageSeconds / 3600);
      const minutes = Math.floor((averageSeconds % 3600) / 60);
      const seconds = Math.floor(averageSeconds % 60);
      return `${hours} —á ${minutes} –º–∏–Ω ${seconds} —Å–µ–∫`;
    }

    // –†–∞—Å—á–µ—Ç –æ–±—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
    function calculateTotalTime() {
      let totalSeconds = 0;
      trackingData.sessions.forEach(session => {
        const sessionEnd = session.end || Date.now();
        if (session.start) {
          totalSeconds += (sessionEnd - session.start) / 1000;
        }
      });
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = Math.floor(totalSeconds % 60);
      return `${hours} —á ${minutes} –º–∏–Ω ${seconds} —Å–µ–∫`;
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤
    function updateReports() {
      const now = new Date();
      const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
      const todayEnd = todayStart + 24 * 60 * 60 * 1000;
      document.getElementById('daily-time').textContent = `–°–µ–≥–æ–¥–Ω—è: ${calculateTimeInPeriod(todayStart, todayEnd)}`;

      const weekStart = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay()).getTime();
      const weekEnd = weekStart + 7 * 24 * 60 * 60 * 1000;
      document.getElementById('weekly').textContent = calculateTimeInPeriod(weekStart, weekEnd);

      const monthStart = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
      const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 1).getTime();
      document.getElementById('monthly').textContent = calculateTimeInPeriod(monthStart, monthEnd);

      document.getElementById('total').textContent = calculateTotalTime();

      document.getElementById('average').textContent = calculateAverageDailyTime();

      const weeklyTimeStr = calculateTimeInPeriod(weekStart, now.getTime());
      const weeklySeconds = parseTimeToSeconds(weeklyTimeStr);
      const weeklyHours = weeklySeconds / 3600;
      const todayStr = new Date().toDateString();
      const lastCheckDate = new Date(parseInt(lastWeeklyCheck)).toDateString();

      if (weeklyHours < 20 && todayStr !== lastCheckDate) {
        const hoursLeft = 20 - weeklyHours;
        showNotification(`–≠–π, —Ç—ã –ø–æ–∫–∞ –æ—Ç—Å—Ç–∞—ë—à—å! –ù–∞–¥–æ –µ—â—ë ${Math.ceil(hoursLeft)} —á —Ç—É—Å–∏—Ç—å –≤ —à–∫–æ–ª–µ, —á—Ç–æ–±—ã –Ω–∞–±—Ä–∞—Ç—å 20 —á–∞—Å–æ–≤ –∑–∞ –Ω–µ–¥–µ–ª—é. –î–∞–≤–∞–π, –ø–æ–¥–Ω–∞–∂–º–∏! üî•`);
        localStorage.setItem('lastWeeklyCheck', Date.now());
      } else if (weeklyHours >= 20 && todayStr !== lastCheckDate) {
        showNotification('–ö—Ä–∞—Å–∞–≤—á–∏–∫, —Ç—ã –Ω–∞–±—Ä–∞–ª 20 —á–∞—Å–æ–≤ –∑–∞ –Ω–µ–¥–µ–ª—é! üí™ –ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ!');
        localStorage.setItem('lastWeeklyCheck', Date.now());
      }
    }

    // –ó–∞–ø—É—Å–∫ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
    function startTracking() {
      if (navigator.geolocation) {
        navigator.permissions.query({ name: 'geolocation' }).then(permissionStatus => {
          if (permissionStatus.state === 'denied') {
            handleError({ code: 1, message: '–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞' });
            return;
          }
          navigator.geolocation.watchPosition(checkLocation, handleError, {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 5000
          });

          navigator.geolocation.getCurrentPosition(position => {
            const { latitude, longitude } = position.coords;
            console.log(`–¢–µ–∫—É—â–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${latitude}, ${longitude}`);
          }, handleError);
        });
      } else {
        document.getElementById('status').textContent = '–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
        showNotification('–ë—Ä–æ, —Ç–≤–æ–π –¥–µ–≤–∞–π—Å –Ω–µ —Ç—è–Ω–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é, —Å–æ—Ä—è–Ω! üòï');
      }
    }

    // Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').then(reg => {
        console.log('Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω');
      }).catch(err => {
        console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ Service Worker:', err);
      });
    }

    // –ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫
    startButton.addEventListener('click', startTimer);
    stopButton.addEventListener('click', stopTimer);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    const isDark = localStorage.getItem('darkTheme') === 'true';
    document.getElementById('dark-theme').checked = isDark;
    document.body.classList.toggle('dark-theme', isDark);
    initUsername();
    updateAchievementsDisplay();
    startTracking();
    updateStatus();
    updateReports();
    checkExportReminder();
  </script>
</body>
</html>
